<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Factory ERP Final</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    h2, h3 { margin-top: 20px; }
    .form-row { margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    input, select, button { padding: 6px; }
    button { cursor: pointer; }
    table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    .page { display: none; }
  </style>
</head>
<body>

<h1>Factory ERP Final</h1>

<!-- ‚úÖ MENU -->
<div class="form-row">
  <button onclick="showPage('employee')">Employee</button>
  <button onclick="showPage('bom')">BOM</button>
  <button onclick="showPage('production')">Production</button>
  <button onclick="showPage('stock')">Stock</button>
  <button onclick="showPage('payroll')">Payroll</button>
  <button onclick="showPage('export')">Export / CBM</button>
</div>

<hr>

<!-- ================= EMPLOYEE ================= -->
<div id="page-employee" class="page">
  <h2>Employee</h2>
  <div class="form-row">
    <input id="empId" placeholder="ID">
    <input id="empName" placeholder="Name">
    <select id="empPayType">
      <option value="piece">Piece</option>
      <option value="monthly">Monthly</option>
    </select>
    <input id="empUnitPay" type="number" placeholder="Unit Pay">
    <button onclick="addEmployee()">Add</button>
  </div>
  <table>
    <thead><tr><th>ID</th><th>Name</th><th>PayType</th><th>UnitPay</th><th>Del</th></tr></thead>
    <tbody id="empBody"></tbody>
  </table>
</div>

<!-- ================= BOM ================= -->
<div id="page-bom" class="page">
  <h2>BOM</h2>
  <div class="form-row">
    <input id="bomProduct" placeholder="Product">
    <input id="bomProcess" placeholder="Process">
    <input id="bomInputCode" placeholder="Input Code">
    <input id="bomInputQty" type="number" placeholder="Qty">
    <input id="bomUnitCost" type="number" placeholder="Unit Cost">
    <input id="bomOutputCode" placeholder="Output Code">
    <button onclick="saveBOM()">Save</button>
  </div>
  <table>
    <thead>
      <tr><th>Product</th><th>Process</th><th>Input</th><th>Qty</th><th>Cost</th><th>Output</th><th>Edit</th></tr>
    </thead>
    <tbody id="bomBody"></tbody>
  </table>
</div>

<!-- ================= PRODUCTION ================= -->
<div id="page-production" class="page">
  <h2>Production</h2>
  <div class="form-row">
    <input id="prodDate" type="date">
    <input id="prodProduct" placeholder="Product">
    <input id="prodProcess" placeholder="Process">

    <input id="prodInputCode" placeholder="Input Code" oninput="autoFillName('prodInputCode','prodInputName')">
    <input id="prodInputName" placeholder="Input Name">

    <input id="prodInputQty" type="number" placeholder="Input Qty">

    <input id="prodOutputCode" placeholder="Output Code" oninput="autoFillName('prodOutputCode','prodOutputName')">
    <input id="prodOutputName" placeholder="Output Name">

    <input id="prodGoodQty" type="number" placeholder="Good Qty">
    <input id="prodDefectQty" type="number" placeholder="Defect Qty">
    <input id="prodWorker" placeholder="Worker ID">
    <input id="prodNote" placeholder="Note">

    <button onclick="saveProduction()">Save</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Product</th><th>Process</th>
        <th>Input</th><th>Output</th><th>Good</th>
        <th>Defect</th><th>Worker</th><th>Note</th><th>Edit</th>
      </tr>
    </thead>
    <tbody id="prodBody"></tbody>
  </table>
</div>

<!-- ================= STOCK ================= -->
<div id="page-stock" class="page">
  <h2>Stock</h2>
  <table>
    <thead><tr><th>Code</th><th>Name</th><th>Good</th><th>Defect</th></tr></thead>
    <tbody id="stockBody"></tbody>
  </table>
</div>

<!-- ================= PAYROLL ================= -->
<div id="page-payroll" class="page">
  <h2>Payroll</h2>
  <div class="form-row">
    <input id="payrollMonth" type="month">
    <button onclick="calcPayroll()">Calculate</button>
    <button onclick="downloadPayroll()">Download CSV</button>
  </div>
  <table>
    <thead><tr><th>ID</th><th>Name</th><th>Qty</th><th>Salary</th></tr></thead>
    <tbody id="payrollBody"></tbody>
  </table>
</div>

<!-- ================= EXPORT / CBM ================= -->
<div id="page-export" class="page">
  <h2>Export / CBM</h2>

  <h3>üì¶ Packing Standard (Code Í∏∞Ï§Ä)</h3>
  <div class="form-row">
    <input id="packCode" placeholder="Product Code (ex: CP01)">
    <input id="innerQty" type="number" placeholder="Inner / Unit (ex: 10)">
    <input id="cartonQty" type="number" placeholder="Carton / Unit (ex: 100)">
    <button onclick="savePackingStandard()">Save Standard</button>
  </div>

  <table>
    <thead>
      <tr><th>Code</th><th>Inner</th><th>Carton</th><th>Edit</th></tr>
    </thead>
    <tbody id="packingBody"></tbody>
  </table>

  <hr>

  <h3>üö¢ CBM Calculator (Carton Í∏∞Ï§Ä)</h3>

  <div class="form-row">
    <input id="cbmCode" placeholder="Product Code (ex: CP01)">
    <input id="unitQty" type="number" placeholder="Finished Product Qty">
  </div>

  <div class="form-row">
    <input id="boxL" type="number" placeholder="Carton Length (cm)">
    <input id="boxW" type="number" placeholder="Carton Width (cm)">
    <input id="boxH" type="number" placeholder="Carton Height (cm)">
    <button onclick="calcCBMByStandard()">Calculate</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Product</th>
        <th>Finished Qty</th>
        <th>Inner Box Qty</th>
        <th>Carton Box Qty</th>
        <th>CBM / Carton</th>
        <th>Total CBM</th>
        <th>20FT Carton</th>
        <th>40HQ Carton</th>
      </tr>
    </thead>
    <tbody id="cbmBody"></tbody>
  </table>

</div>

<script>
function load(key){ return JSON.parse(localStorage.getItem(key)||"[]");}
function save(key,val){ localStorage.setItem(key,JSON.stringify(val));}

/* ‚úÖ PAGE */
function showPage(page){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById("page-"+page).style.display="block";
}

/* ‚úÖ CODE ‚Üí NAME AUTO */
function autoFillName(codeId, nameId){
  const code=document.getElementById(codeId).value.trim();
  const nameInput=document.getElementById(nameId);
  const stock=load("stock");
  const found=stock.find(s=>s.code===code);

  if(found && found.name){
    nameInput.value=found.name;
    nameInput.readOnly=true;
  }else{
    nameInput.value="";
    nameInput.readOnly=false;
  }
}

/* ‚úÖ EMPLOYEE */
function addEmployee(){
  if(!empId.value||!empName.value||!empUnitPay.value)return alert("Input Missing");
  const list=load("employees");
  list.push({id:empId.value,name:empName.value,payType:empPayType.value,unitPay:Number(empUnitPay.value)});
  save("employees",list);
  empId.value=""; empName.value=""; empUnitPay.value="";
  renderEmployees();
}
function renderEmployees(){
  empBody.innerHTML="";
  load("employees").forEach((e,i)=>{
    empBody.innerHTML+=`
      <tr>
        <td>${e.id}</td><td>${e.name}</td><td>${e.payType}</td><td>${e.unitPay}</td>
        <td><button onclick="delEmp(${i})">X</button></td>
      </tr>`;
  });
}
function delEmp(i){
  const l=load("employees"); l.splice(i,1); save("employees",l); renderEmployees();
}

/* ‚úÖ BOM */
function saveBOM(){
  const l=load("bom");
  l.push({
    product:bomProduct.value,
    process:bomProcess.value,
    inputCode:bomInputCode.value,
    inputQty:Number(bomInputQty.value),
    unitCost:Number(bomUnitCost.value),
    outputCode:bomOutputCode.value
  });
  save("bom",l); renderBOM();
}
function renderBOM(){
  bomBody.innerHTML="";
  load("bom").forEach((b,i)=>{
    bomBody.innerHTML+=`
      <tr>
        <td>${b.product}</td><td>${b.process}</td><td>${b.inputCode}</td>
        <td>${b.inputQty}</td><td>${b.unitCost}</td><td>${b.outputCode}</td>
        <td><button onclick="editBOM(${i})">Edit</button></td>
      </tr>`;
  });
}
function editBOM(i){
  const b=load("bom")[i];
  bomProduct.value=b.product;
  bomProcess.value=b.process;
  bomInputCode.value=b.inputCode;
  bomInputQty.value=b.inputQty;
  bomUnitCost.value=b.unitCost;
  bomOutputCode.value=b.outputCode;
  const l=load("bom"); l.splice(i,1); save("bom",l); renderBOM();
}

/* ‚úÖ STOCK */
function adjustStock(code,name,good,defect){
  const stock=load("stock");
  let item=stock.find(s=>s.code===code);
  if(!item){
    item={code,name:name||"",good:0,defect:0};
    stock.push(item);
  }
  item.good+=good; item.defect+=defect;
  if(!item.name && name) item.name=name;
  save("stock",stock);
  renderStock();
}
function renderStock(){
  stockBody.innerHTML="";
  load("stock").forEach(s=>{
    stockBody.innerHTML+=`
      <tr>
        <td>${s.code}</td><td>${s.name||""}</td><td>${s.good}</td><td>${s.defect}</td>
      </tr>`;
  });
}

/* ‚úÖ PRODUCTION */
function saveProduction(){
  const row={
    date:prodDate.value||new Date().toISOString().split("T")[0],
    product:prodProduct.value,
    process:prodProcess.value,
    inputCode:prodInputCode.value,
    inputQty:Number(prodInputQty.value),
    inputName:prodInputName.value,
    outputCode:prodOutputCode.value,
    outputName:prodOutputName.value,
    goodQty:Number(prodGoodQty.value),
    defectQty:Number(prodDefectQty.value),
    worker:prodWorker.value,
    note:prodNote.value
  };

  const log=load("productionLog");
  log.push(row); save("productionLog",log);

  adjustStock(row.inputCode,row.inputName,-row.inputQty,0);
  adjustStock(row.outputCode,row.outputName,row.goodQty,row.defectQty);

  renderProduction();
}
function renderProduction(){
  prodBody.innerHTML="";
  load("productionLog").forEach((p,i)=>{
    prodBody.innerHTML+=`
      <tr>
        <td>${p.date}</td><td>${p.product}</td><td>${p.process}</td>
        <td>${p.inputCode}</td><td>${p.outputCode}</td>
        <td>${p.goodQty}</td><td>${p.defectQty}</td>
        <td>${p.worker}</td><td>${p.note||""}</td>
        <td><button onclick="editProduction(${i})">Edit</button></td>
      </tr>`;
  });
}
function editProduction(i){
  const p=load("productionLog")[i];
  prodDate.value=p.date;
  prodProduct.value=p.product;
  prodProcess.value=p.process;
  prodInputCode.value=p.inputCode;
  prodInputName.value=p.inputName;
  prodInputQty.value=p.inputQty;
  prodOutputCode.value=p.outputCode;
  prodOutputName.value=p.outputName;
  prodGoodQty.value=p.goodQty;
  prodDefectQty.value=p.defectQty;
  prodWorker.value=p.worker;
  prodNote.value=p.note;

  const l=load("productionLog"); l.splice(i,1); save("productionLog",l); renderProduction();
}

/* ‚úÖ PAYROLL */
let payrollCache=[];
function calcPayroll(){
  payrollBody.innerHTML="";
  payrollCache=[];
  const month=payrollMonth.value;
  const emp=load("employees"), log=load("productionLog");

  emp.forEach(e=>{
    let qty=0;
    log.forEach(r=>{
      if(r.worker===e.id && r.date.startsWith(month)) qty+=r.goodQty;
    });
    const salary=e.payType==="piece"?qty*e.unitPay:e.unitPay;
    payrollBody.innerHTML+=`
      <tr><td>${e.id}</td><td>${e.name}</td><td>${qty}</td><td>${salary}</td></tr>`;
    payrollCache.push({id:e.id,name:e.name,qty,salary});
  });
}
function downloadPayroll(){
  let csv="ID,Name,Qty,Salary\n";
  payrollCache.forEach(r=>{
    csv+=`${r.id},${r.name},${r.qty},${r.salary}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="payroll.csv";
  a.click();
}

/* ‚úÖ PACKING STANDARD */
function savePackingStandard() {
  const code = packCode.value.trim();
  const inner = Number(innerQty.value);
  const carton = Number(cartonQty.value);

  if (!code || !inner || !carton) {
    alert("Í∏∞Ï§Ä Ï†ïÎ≥¥ ÎàÑÎùΩ");
    return;
  }

  const list = load("packingStandard");
  const exist = list.find(p => p.code === code);

  if (exist) {
    exist.inner = inner;
    exist.carton = carton;
  } else {
    list.push({ code, inner, carton });
  }

  save("packingStandard", list);
  packCode.value = ""; innerQty.value = ""; cartonQty.value = "";
  renderPackingStandard();
}

function renderPackingStandard() {
  packingBody.innerHTML = "";
  load("packingStandard").forEach((p, i) => {
    packingBody.innerHTML += `
      <tr>
        <td>${p.code}</td>
        <td>${p.inner}</td>
        <td>${p.carton}</td>
        <td><button onclick="editPackingStandard(${i})">Edit</button></td>
      </tr>
    `;
  });
}

function editPackingStandard(i) {
  const p = load("packingStandard")[i];
  packCode.value = p.code;
  innerQty.value = p.inner;
  cartonQty.value = p.carton;
  const list = load("packingStandard");
  list.splice(i, 1);
  save("packingStandard", list);
  renderPackingStandard();
}

/* ‚úÖ CBM BY STANDARD */
function calcCBMByStandard() {
  const code = cbmCode.value.trim();
  const unitQtyVal = Number(unitQty.value);
  const L = Number(boxL.value);
  const W = Number(boxW.value);
  const H = Number(boxH.value);

  if (!code || !unitQtyVal || !L || !W || !H) {
    alert("ÌïÑÏàò Í∞í ÎàÑÎùΩ");
    return;
  }

  const standards = load("packingStandard");
  const std = standards.find(p => p.code === code);

  if (!std) {
    alert("Ìï¥Îãπ ÏΩîÎìúÏùò Ìè¨Ïû• Í∏∞Ï§ÄÏù¥ ÏóÜÏäµÎãàÎã§.");
    return;
  }

  const innerBoxQty = Math.ceil(unitQtyVal / std.inner);
  const cartonBoxQty = Math.ceil(unitQtyVal / std.carton);

  const cbmPerCarton = (L * W * H) / 1000000;
  const totalCBM = cbmPerCarton * cartonBoxQty;

  const FT20 = 33;
  const FT40HQ = 68;

  const fit20 = Math.floor(FT20 / cbmPerCarton);
  const fit40 = Math.floor(FT40HQ / cbmPerCarton);

  cbmBody.innerHTML = `
    <tr>
      <td>${code}</td>
      <td>${unitQtyVal.toLocaleString()}</td>
      <td>${innerBoxQty.toLocaleString()}</td>
      <td>${cartonBoxQty.toLocaleString()}</td>
      <td>${cbmPerCarton.toFixed(4)}</td>
      <td>${totalCBM.toFixed(2)}</td>
      <td>${fit20.toLocaleString()}</td>
      <td>${fit40.toLocaleString()}</td>
    </tr>
  `;
}

/* ‚úÖ INIT */
showPage("employee");
renderEmployees();
renderBOM();
renderProduction();
renderStock();
renderPackingStandard();
</script>

</body>
</html>
