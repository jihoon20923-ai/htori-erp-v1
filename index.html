<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HTORI ERP Realtime - v1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* --- 기본 레이아웃 / 스타일 (간결) --- */
    :root{--nav-w:220px;--accent:#1F3C88;--bg:#f2f5f8;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#222}
    .site-header{height:60px;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:fixed;left:0;right:0;top:0;z-index:40}
    .brand{font-weight:700;display:flex;align-items:center;gap:8px}
    .layout{display:flex;padding-top:60px;min-height:calc(100vh - 60px)}
    .sidebar{width:var(--nav-w);background:#11151a;color:#fff;padding:12px;min-height:calc(100vh - 60px)}
    .menu-list{list-style:none;padding:0;margin:0}
    .menu-list li{margin-bottom:8px}
    .menu-btn{display:block;width:100%;text-align:left;padding:10px;border-radius:6px;background:transparent;color:#ddd;border:0;cursor:pointer}
    .menu-btn.active{background:#222}
    .content{flex:1;padding:20px}
    .card{background:var(--card);padding:14px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:12px}
    h1,h2{margin:0 0 12px 0}
    .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.warning{background:#ff7a59;color:#fff}
    .muted{color:#666}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type=text], select, input[type=number], textarea, input[type=date]{width:100%;padding:8px;border:1px solid #d4d9df;border-radius:6px}
    .form-row{display:flex;gap:10px}
    .form-col{flex:1}
    .small{font-size:13px}
    .hidden{display:none}
    .top-right{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e6e9ec;padding:8px;text-align:left}
    .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:80}
    .modal-card{width:420px;background:#fff;padding:18px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.25)}
    .sr-only{position:absolute;left:-9999px}
    .topbar-right{display:flex;gap:8px;align-items:center}
    .lang-btn{background:#fff;border:1px solid #ddd;padding:6px;border-radius:6px;cursor:pointer}
    .help{color:#999;font-size:13px}
    .notice{padding:8px;background:#eef7ff;border-left:4px solid #1F3C88}
    .flex{display:flex;gap:8px;align-items:center}
    .mb8{margin-bottom:8px}
  </style>

  <!-- Firebase + XLSX CDN (인터넷 필요) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="brand">
      <img id="brand-logo" src="logo.png" alt="logo" style="height:34px" onerror="this.style.display='none'">
      <div>
        <div style="font-size:16px">HTORI ERP Realtime</div>
        <div style="font-size:11px;opacity:.9">v1</div>
      </div>
    </div>

    <div class="topbar-right">
      <div class="top-right">
        <div id="user-info" style="font-size:14px">User: <span id="user-name">Guest</span> (<span id="user-role">viewer</span>)</div>
      </div>
      <div>
        <button class="lang-btn" data-lang="EN">EN</button>
        <button class="lang-btn" data-lang="KR">KR</button>
        <button class="lang-btn" data-lang="ID">ID</button>
      </div>
      <button id="logoutBtn" class="btn small hidden">Logout</button>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="layout">
    <aside class="sidebar">
      <ul id="menuList" class="menu-list"></ul>
    </aside>

    <main id="content" class="content">
      <!-- content injected -->
    </main>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal-card">
      <h2 style="text-align:center;margin-bottom:12px">HTORI ERP LOGIN</h2>

      <div class="mb8">
        <label for="loginId">ID</label>
        <input id="loginId" placeholder="admin">
      </div>

      <div class="mb8">
        <label for="loginPw">Password</label>
        <input id="loginPw" type="password" placeholder="1234">
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="demoBtn" class="btn">Demo</button>
        <button id="loginBtn" class="btn primary">Login</button>
      </div>

      <div id="loginNotice" class="muted small" style="margin-top:8px">첫 실행 시 기본 계정: admin / 1234</div>
    </div>
  </div>

  <!-- TEMPLATES (간단한 마크업 틀) -->
  <template id="tpl-dashboard">
    <div>
      <h1 data-i18n="dashboard">Dashboard</h1>
      <div class="card">
        <h3>Overview (placeholder)</h3>
        <p class="muted">Summary widgets (sales, production, stock) will be integrated here.</p>
      </div>
    </div>
  </template>

  <template id="tpl-settings">
    <div>
      <h1>Settings</h1>
      <div class="card">
        <label>Default language</label>
        <select id="settingDefaultLang">
          <option>EN</option><option>KR</option><option>ID</option>
        </select>

        <label style="margin-top:12px">Menu order (comma separated)</label>
        <input id="settingMenuOrder" placeholder="dashboard,production,outsource,shipment,cost,employees,receiving,settings">

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="saveSettingsBtn" class="btn primary">Save</button>
          <button id="resetDataBtn" class="btn warning">RESET DB (danger)</button>
        </div>
        <p class="muted" style="margin-top:8px">Menu keys: dashboard,production,outsource,shipment,cost,employees,receiving,order,mrp,excel</p>
      </div>
    </div>
  </template>

  <!-- SCRIPTS: 앱 로직 -->
  <script>
  /* =================================================
   CONFIG (Firebase)
   - 이미 주신 config를 사용합니다.
================================================= */
const firebaseConfig = {
  apiKey: "AIzaSyDwiTlPtoXraEtA7TzTctdH6DJS6gdSEGQ",
  authDomain: "htori-erp-3c22b.firebaseapp.com",
  databaseURL: "https://htori-erp-3c22b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "htori-erp-3c22b",
  storageBucket: "htori-erp-3c22b.firebasestorage.app",
  messagingSenderId: "975336397666",
  appId: "1:975336397666:web:ae45a471e51bf71e9dea3b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();


/* =================================================
   AUTO CREATE ADMIN (FINAL, FIXED VERSION)
================================================= */
(async function ensureAdmin(){
  try {
    const snap = await db.ref("employees").once("value");
    let needCreate = false;

    if(!snap.exists()){
      needCreate = true;
    } else {
      const list = snap.val() || {};
      const hasAdmin = Object.values(list).some(e => e && e.id === "admin");
      const hasValid = Object.values(list).some(e => e && e.id && e.pw);
      if(!hasAdmin || !hasValid) needCreate = true;
    }

    if(needCreate){
      const admin = {
        id: "admin",
        pw: "1234",
        name: "Master",
        role: "master",
        createdAt: new Date().toISOString()
      };
      await db.ref("employees").push(admin);
      console.log("✅ Admin auto-created");
    } else {
      console.log("ℹ Admin exists");
    }
  } catch(err){
    console.error("❌ ensureAdmin error:", err);
  }
})();


  /* =================================================
     App State
  ================================================= */
  let currentUser = null;
  let lang = localStorage.getItem("htori_lang") || "EN";
  const DEFAULT_MENU = "dashboard,production,outsource,shipment,cost,employees,receiving,order,mrp,excel,settings";

  const T = {
    EN:{
      dashboard: "Dashboard",
      production: "Production",
      outsource: "Outsource",
      shipment: "Shipment",
      cost: "Cost & Profit",
      employees: "Employee Management",
      receiving: "Stock / Receiving",
      order: "Orders",
      mrp: "MRP / Purchase",
      excel: "Excel Upload",
      settings: "Settings"
    },
    KR:{
      dashboard: "대시보드",
      production: "생산",
      outsource: "외주",
      shipment: "출고",
      cost: "손익",
      employees: "직원관리",
      receiving: "재고 / 입고",
      order: "주문",
      mrp: "MRP / 발주",
      excel: "엑셀 업로드",
      settings: "설정"
    },
    ID:{
      dashboard: "Dasbor",
      production: "Produksi",
      outsource: "Outsourcing",
      shipment: "Pengiriman",
      cost: "Biaya & Laba",
      employees: "Manajemen Karyawan",
      receiving: "Stok / Penerimaan",
      order: "Pesanan",
      mrp: "MRP / Pembelian",
      excel: "Upload Excel",
      settings: "Pengaturan"
    }
  };

  /* -------------------------
     DOM refs
  ------------------------- */
  const content = document.getElementById("content");
  const menuList = document.getElementById("menuList");
  const loginModal = document.getElementById("loginModal");
  const loginBtn = document.getElementById("loginBtn");
  const demoBtn = document.getElementById("demoBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userNameSpan = document.getElementById("user-name");
  const userRoleSpan = document.getElementById("user-role");

  /* =================================================
     Initialization: ensure admin exists (once)
  ================================================= */
  db.ref("employees").once("value").then(snap=>{
    if(!snap.exists()){
      db.ref("employees").push({ id:"admin", pw:"1234", name:"Master", role:"master", bank:"", account:"", tax:"", salaryBase:0, payPerHour:0, payPerPiece:0, probation:false });
      console.log("admin created");
    }
  });

  /* =================================================
     Render Menu according to settings & role
  ================================================= */
  function getMenuOrder(){
    const v = localStorage.getItem("htori_menu_order");
    return v ? v.split(",").map(s=>s.trim()).filter(Boolean) : DEFAULT_MENU.split(",").map(s=>s.trim());
  }

  function setMenuOrder(arr){
    localStorage.setItem("htori_menu_order", arr.join(","));
  }

  function renderMenu(){
    menuList.innerHTML = "";
    const order = getMenuOrder();
    order.forEach(key=>{
      // skip unknown keys
      const title = (T[lang] && T[lang][key]) ? T[lang][key] : key;
      const li = document.createElement("li");
      li.innerHTML = `<button class="menu-btn" data-key="${key}">${title}</button>`;
      menuList.appendChild(li);
    });

    // attach click handlers
    Array.from(document.querySelectorAll(".menu-btn")).forEach(btn=>{
      btn.addEventListener("click", ()=> {
        Array.from(document.querySelectorAll(".menu-btn")).forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const key = btn.dataset.key;
        showPage(key);
      });
    });
  }

  /* =================================================
     Language switching (immediate)
  ================================================= */
  function setLanguage(l){
    lang = l;
    localStorage.setItem("htori_lang", l);
    renderMenu();
    // refresh current page title if applicable
    const active = document.querySelector(".menu-btn.active");
    if(active) showPage(active.dataset.key);
  }
  document.querySelectorAll(".lang-btn").forEach(b=>{
    b.addEventListener("click", ()=> setLanguage(b.dataset.lang));
  });

  /* =================================================
     Login / Logout
  ================================================= */
  loginBtn.addEventListener("click", login);
  demoBtn.addEventListener("click", demoLogin);
  logoutBtn.addEventListener("click", logout);

  function demoLogin(){
    // guest viewer
    currentUser = { id:"guest", name:"Guest", role:"viewer" };
    onLogin();
  }

 function login(){
    const id = document.getElementById("loginId").value.trim();
    const pw = document.getElementById("loginPw").value.trim();

    if(!id || !pw) return alert("Enter credentials");

    db.ref("employees").once("value").then(s=>{
        const list = s.val() || {};

        const found = Object.values(list).find(x=>x.id===id && x.pw===pw);
        if(!found){
            alert("LOGIN FAIL");
            return;
        }

        currentUser = found;
        onLogin();      // 클래식 erp UI show 삭제됨 → 지금은 이게 필요함
    });
}

  function logout(){
    currentUser = null;
    document.getElementById("user-name").innerText = "Guest";
    document.getElementById("user-role").innerText = "viewer";
    logoutBtn.classList.add("hidden");
    // show login modal
    loginModal.classList.remove("hidden");
  }

  function onLogin(){
    document.getElementById("user-name").innerText = currentUser.name || currentUser.id;
    document.getElementById("user-role").innerText = currentUser.role || "user";
    loginModal.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    renderMenu();
    // open dashboard
    const order = getMenuOrder();
    showPage(order[0]||"dashboard");
  }

  /* =================================================
     Page Renderer
  ================================================= */
  function showPage(key){
    // key -> render page
    if(key === "dashboard") return renderDashboard();
    if(key === "settings") return renderSettings();
    if(key === "employees") return renderEmployees();
    if(key === "production") return renderProduction();
    if(key === "outsource") return renderOutsource();
    if(key === "receiving") return renderReceiving();
    if(key === "order") return renderOrders();
    if(key === "excel") return renderExcelUpload();
    if(key === "mrp") return renderMRP();
    // fallback
    content.innerHTML = `<div><h2>${T[lang][key]||key}</h2><div class="card"><p>Page not implemented yet.</p></div></div>`;
  }

  /* ---------------------------
     Dashboard
  --------------------------- */
  function renderDashboard(){
    const tpl = document.getElementById("tpl-dashboard").content.cloneNode(true);
    content.innerHTML = "";
    content.appendChild(tpl);
  }

  /* ---------------------------
     Settings
  --------------------------- */
  function renderSettings(){
    const tpl = document.getElementById("tpl-settings").content.cloneNode(true);
    content.innerHTML = "";
    content.appendChild(tpl);

    // init values
    const sel = document.getElementById("settingDefaultLang");
    sel.value = lang;
    document.getElementById("settingMenuOrder").value = getMenuOrder().join(",");

    document.getElementById("saveSettingsBtn").addEventListener("click", ()=>{
      const newLang = document.getElementById("settingDefaultLang").value;
      setLanguage(newLang);
      const order = document.getElementById("settingMenuOrder").value.split(",").map(s=>s.trim()).filter(Boolean);
      setMenuOrder(order);
      renderMenu();
      alert("Saved");
    });

    document.getElementById("resetDataBtn").addEventListener("click", ()=>{
      if(!confirm("Reset ALL data in Firebase root? This is irreversible.")) return;
      db.ref().set({ employees: { 0: { id:"admin", pw:"1234", name:"Master", role:"master" } }, materials: {}, stock: {}, processes: {}, production_log: {}, orders: {}, outsourcing: {} });
      alert("Reset done");
    });
  }

  /* ---------------------------
     Employees
  --------------------------- */
  function renderEmployees(){
    content.innerHTML = `<h1>Employees</h1><div class="card" id="empFormCard"></div><div class="card"><h3>Employee List</h3><div id="empList"></div></div>`;
    const formHtml = `
      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label>Employee ID</label><input id="emp_id" type="text">
        </div>
        <div style="flex:1">
          <label>Name</label><input id="emp_name" type="text">
        </div>
        <div style="width:160px">
          <label>Role</label>
          <select id="emp_role"><option value="operator">Operator</option><option value="master">Master</option><option value="viewer">Viewer</option></select>
        </div>
      </div>

      <div class="form-row mb8" style="margin-top:8px">
        <div class="form-col">
          <label>Employment Type</label>
          <select id="emp_type"><option>PKWT</option><option>PKWTT</option></select>
        </div>
        <div class="form-col">
          <label>Join Date</label>
          <input id="emp_join" type="date">
        </div>
        <div class="form-col">
          <label>Probation</label>
          <input id="emp_prob" type="checkbox">
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label>Base Salary (monthly)</label><input id="emp_base" type="number">
        </div>
        <div style="flex:1">
          <label>Pay per hour</label><input id="emp_hour" type="number">
        </div>
        <div style="flex:1">
          <label>Pay per piece</label><input id="emp_piece" type="number">
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>Bank</label><input id="emp_bank" type="text">
        </div>
        <div style="flex:1">
          <label>Account</label><input id="emp_account" type="text">
        </div>
        <div style="flex:1">
          <label>TAX ID</label><input id="emp_tax" type="text">
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Memo</label><textarea id="emp_memo" rows="2"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button id="empSaveBtn" class="btn primary">Save</button>
        <button id="empClearBtn" class="btn">Clear</button>
      </div>
    `;
    document.getElementById("empFormCard").innerHTML = formHtml;

    document.getElementById("empSaveBtn").addEventListener("click", ()=>{
      const payload = {
        id: document.getElementById("emp_id").value.trim(),
        name: document.getElementById("emp_name").value.trim(),
        role: document.getElementById("emp_role").value,
        type: document.getElementById("emp_type").value,
        joinDate: document.getElementById("emp_join").value,
        probation: document.getElementById("emp_prob").checked,
        baseSalary: Number(document.getElementById("emp_base").value||0),
        payHour: Number(document.getElementById("emp_hour").value||0),
        payPiece: Number(document.getElementById("emp_piece").value||0),
        bank: document.getElementById("emp_bank").value.trim(),
        account: document.getElementById("emp_account").value.trim(),
        tax: document.getElementById("emp_tax").value.trim(),
        memo: document.getElementById("emp_memo").value.trim()
      };
      if(!payload.id) return alert("Employee ID required");
      db.ref("employees").push(payload).then(()=>{ alert("Saved"); loadEmployeeList(); clearEmpForm(); });
    });

    document.getElementById("empClearBtn").addEventListener("click", clearEmpForm);
    loadEmployeeList();
  }

  function clearEmpForm(){
    ['emp_id','emp_name','emp_base','emp_hour','emp_piece','emp_bank','emp_account','emp_tax','emp_memo'].forEach(id=>document.getElementById(id).value="");
    document.getElementById("emp_prob").checked=false;
  }

  function loadEmployeeList(){
    const div = document.getElementById("empList");
    div.innerHTML = "<em>Loading...</em>";
    db.ref("employees").once("value").then(snap=>{
      const list = snap.val() || {};
      let html = `<table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Type</th><th>Base</th><th>Hour</th><th>Piece</th><th>Bank</th><th>Tax</th></tr></thead><tbody>`;
      Object.values(list).forEach(e=>{
        html += `<tr><td>${escapeHtml(e.id||"")}</td><td>${escapeHtml(e.name||"")}</td><td>${escapeHtml(e.role||"")}</td><td>${escapeHtml(e.type||"")}</td><td>${e.baseSalary||0}</td><td>${e.payHour||0}</td><td>${e.payPiece||0}</td><td>${escapeHtml(e.bank||"")}</td><td>${escapeHtml(e.tax||"")}</td></tr>`;
      });
      html += `</tbody></table>`;
      div.innerHTML = html;
    });
  }

  /* ---------------------------
     Process Master (공정 마스터)
  --------------------------- */
  function renderProcessMaster(){
    const html = `
      <h1>Process Master</h1>
      <div class="card">
        <div class="form-row">
          <div class="form-col"><label>Process Code</label><input id="p_code" type="text"></div>
          <div class="form-col"><label>Name (EN)</label><input id="p_name_en" type="text"></div>
          <div class="form-col"><label>Name (KR)</label><input id="p_name_kr" type="text"></div>
        </div>
        <div class="form-row" style="margin-top:8px">
          <div class="form-col"><label>Name (ID)</label><input id="p_name_id" type="text"></div>
          <div style="width:160px"><label>Price Type</label><select id="p_type"><option value="hour">Per Hour</option><option value="piece">Per Piece</option><option value="outsource">Outsource</option></select></div>
          <div style="width:180px"><label>Unit Price</label><input id="p_price" type="number" step="0.01"></div>
        </div>
        <div style="margin-top:8px"><label>Memo</label><textarea id="p_memo" rows="2"></textarea></div>
        <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px"><button id="p_save" class="btn primary">Save</button><button id="p_clear" class="btn">Clear</button></div>
      </div>

      <div class="card">
        <h3>Processes</h3>
        <div id="processList">Loading...</div>
      </div>
    `;
    content.innerHTML = html;

    document.getElementById("p_save").addEventListener("click", ()=>{
      const code = document.getElementById("p_code").value.trim();
      if(!code) return alert("Process code required");
      const obj = {
        code,
        name:{ en: document.getElementById("p_name_en").value.trim(), kr: document.getElementById("p_name_kr").value.trim(), id: document.getElementById("p_name_id").value.trim() },
        type: document.getElementById("p_type").value,
        price: Number(document.getElementById("p_price").value||0),
        memo: document.getElementById("p_memo").value.trim()
      };
      // check duplicate
      db.ref("processes").orderByChild("code").equalTo(code).once("value").then(snap=>{
        if(snap.exists()){
          alert("Duplicate code. Edit not implemented here. Remove or change code.");
          return;
        }
        db.ref("processes").push(obj).then(()=>{ loadProcessList(); clearProcessForm(); });
      });
    });

    document.getElementById("p_clear").addEventListener("click", clearProcessForm);
    loadProcessList();
  }

  function clearProcessForm(){
    ['p_code','p_name_en','p_name_kr','p_name_id','p_price','p_memo'].forEach(id=>document.getElementById(id).value="");
    document.getElementById("p_type").value="hour";
  }

  function loadProcessList(){
    const dom = document.getElementById("processList");
    dom.innerHTML = "Loading...";
    db.ref("processes").once("value").then(snap=>{
      const list = snap.val() || {};
      let html = `<table><thead><tr><th>Code</th><th>Name(EN)</th><th>Type</th><th>Price</th><th>Memo</th></tr></thead><tbody>`;
      Object.values(list).forEach(p=>{
        html += `<tr><td>${escapeHtml(p.code||"")}</td><td>${escapeHtml(p.name?.en||"")}</td><td>${escapeHtml(p.type||"")}</td><td>${p.price||0}</td><td>${escapeHtml(p.memo||"")}</td></tr>`;
      });
      html += `</tbody></table>`;
      dom.innerHTML = html;
    });
  }

  /* ---------------------------
     Production Input (공정별 작업 입력)
  --------------------------- */
  function renderProduction(){
    // load processes for dropdown
    db.ref("processes").once("value").then(snap=>{
      const list = snap.val() || {};
      const opts = Object.values(list).map(p=>`<option value="${p.code}">${p.code} - ${escapeHtml(p.name?.en||p.name?.kr||p.name?.id||"")}</option>`).join("");
      content.innerHTML = `
        <h1>Production Input</h1>
        <div class="card">
          <div class="form-row">
            <div class="form-col">
              <label>Product Code</label><input id="prod_code" type="text">
            </div>
            <div style="width:180px">
              <label>Process</label>
              <select id="prod_process">${opts}</select>
            </div>
            <div style="width:120px">
              <label>Date</label><input id="prod_date" type="date" value="${new Date().toISOString().split("T")[0]}">
            </div>
            <div style="width:140px">
              <label>Qty</label><input id="prod_qty" type="number" value="0">
            </div>
          </div>

          <div style="margin-top:8px">
            <div class="form-row">
              <div class="form-col">
                <label>Worker (ID)</label><input id="prod_worker">
              </div>
              <div style="width:140px"><label>Hours</label><input id="prod_hours" type="number" value="0"></div>
              <div style="width:140px"><label>Pieces</label><input id="prod_pieces" type="number" value="0"></div>
            </div>
          </div>

          <div style="margin-top:8px">
            <label>Memo</label><textarea id="prod_memo" rows="2"></textarea>
          </div>

          <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
            <button id="prod_save" class="btn primary">Save Production</button>
          </div>
        </div>

        <div class="card">
          <h3>Recent Production</h3>
          <div id="prodList">Loading...</div>
        </div>
      `;
      document.getElementById("prod_save").addEventListener("click", saveProduction);
      loadRecentProduction();
    });
  }

  function saveProduction(){
    const code = document.getElementById("prod_code").value.trim();
    const process = document.getElementById("prod_process").value;
    const date = document.getElementById("prod_date").value;
    const qty = Number(document.getElementById("prod_qty").value||0);
    const hours = Number(document.getElementById("prod_hours").value||0);
    const pieces = Number(document.getElementById("prod_pieces").value||0);
    const worker = document.getElementById("prod_worker").value.trim();
    const memo = document.getElementById("prod_memo").value.trim();

    if(!process || (!qty && !hours && !pieces)) return alert("Enter process and work amounts");

    // fetch process price type
    db.ref("processes").orderByChild("code").equalTo(process).once("value").then(snap=>{
      const p = Object.values(snap.val()||{})[0];
      let cost = 0;
      if(p){
        if(p.type === "hour") cost = p.price * hours;
        else if(p.type === "piece") cost = p.price * pieces;
        else cost = p.price * qty;
      }

      const rec = { productCode: code, process, date, qty, hours, pieces, worker, memo, cost, createdAt: new Date().toISOString() };
      db.ref("production_log").push(rec).then(()=>{ alert("Saved"); loadRecentProduction(); });
    });
  }

  function loadRecentProduction(){
    const dom = document.getElementById("prodList");
    db.ref("production_log").limitToLast(50).once("value").then(snap=>{
      const list = snap.val() || {};
      let html = `<table><thead><tr><th>Date</th><th>Product</th><th>Process</th><th>Qty</th><th>Hours</th><th>Pieces</th><th>Cost</th></tr></thead><tbody>`;
      Object.values(list).forEach(r=>{
        html += `<tr><td>${escapeHtml(r.date||"")}</td><td>${escapeHtml(r.productCode||"")}</td><td>${escapeHtml(r.process||"")}</td><td>${r.qty||0}</td><td>${r.hours||0}</td><td>${r.pieces||0}</td><td>${r.cost||0}</td></tr>`;
      });
      html += `</tbody></table>`;
      dom.innerHTML = html;
    });
  }

  /* ---------------------------
     Out-source (간단)
  --------------------------- */
  function renderOutsource(){
    content.innerHTML = `
      <h1>Outsourcing</h1>
      <div class="card">
        <div style="display:flex;gap:8px">
          <div style="flex:1"><label>Vendor Code</label><input id="os_vendor"></div>
          <div style="flex:2"><label>Vendor Name</label><input id="os_vendor_name"></div>
          <div style="width:160px"><label>Process</label><input id="os_process"></div>
          <div style="width:120px"><label>Qty</label><input id="os_qty" type="number"></div>
        </div>
        <div style="margin-top:8px"><label>Unit Price</label><input id="os_price" type="number"></div>
        <div style="margin-top:8px"><label>Memo</label><textarea id="os_memo" rows="2"></textarea></div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end"><button id="os_save" class="btn primary">Out</button></div>
      </div>

      <div class="card"><h3>Outsourced List</h3><div id="os_list">Loading...</div></div>
    `;
    document.getElementById("os_save").addEventListener("click", ()=>{
      const obj = {
        vendor: document.getElementById("os_vendor").value.trim(),
        vendorName: document.getElementById("os_vendor_name").value.trim(),
        process: document.getElementById("os_process").value.trim(),
        qty: Number(document.getElementById("os_qty").value||0),
        price: Number(document.getElementById("os_price").value||0),
        memo: document.getElementById("os_memo").value.trim(),
        status: "OUT",
        createdAt: new Date().toISOString()
      };
      db.ref("outsourcing").push(obj).then(()=>loadOutsourceList());
    });
    loadOutsourceList();
  }

  function loadOutsourceList(){
    db.ref("outsourcing").once("value").then(snap=>{
      const list = snap.val() || {};
      let html = `<table><thead><tr><th>Date</th><th>Vendor</th><th>Process</th><th>Qty</th><th>Price</th><th>Status</th></tr></thead><tbody>`;
      Object.values(list).forEach(r=>{
        html += `<tr><td>${escapeHtml(r.createdAt||"")}</td><td>${escapeHtml(r.vendorName||r.vendor||"")}</td><td>${escapeHtml(r.process||"")}</td><td>${r.qty||0}</td><td>${r.price||0}</td><td>${r.status||""}</td></tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("os_list").innerHTML = html;
    });
  }

  /* ---------------------------
     Receiving / Stock
  --------------------------- */
  function renderReceiving(){
    content.innerHTML = `
      <h1>Receiving</h1>
      <div class="card">
        <div class="form-row">
          <div class="form-col"><label>Date</label><input id="recv_date" type="date" value="${new Date().toISOString().split("T")[0]}"></div>
          <div class="form-col"><label>Vendor</label><input id="recv_vendor"></div>
          <div class="form-col"><label>Method</label><select id="recv_method"><option>SEA</option><option>AIR</option></select></div>
        </div>
        <div style="margin-top:8px" id="recv_items_area">
          <div class="form-row mb8">
            <div class="form-col"><label>Code</label><input class="recv_code"></div>
            <div class="form-col"><label>Name</label><input class="recv_name"></div>
            <div style="width:120px"><label>Qty</label><input class="recv_qty" type="number"></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addRecvRow" class="btn">+ Add Row</button>
          <button id="saveRecv" class="btn primary">Save Receiving</button>
        </div>
      </div>

      <div class="card"><h3>Current Stock</h3><div id="stockList">Loading...</div></div>
      <div class="card"><h3>Receiving Log</h3><div id="recvLog">Loading...</div></div>
    `;
    document.getElementById("addRecvRow").addEventListener("click", addRecvRow);
    document.getElementById("saveRecv").addEventListener("click", saveReceiving);
    loadStock();
    loadRecvLog();
  }

  function addRecvRow(){
    const area = document.getElementById("recv_items_area");
    const div = document.createElement("div");
    div.className = "form-row mb8";
    div.innerHTML = `<div class="form-col"><label class="sr-only">Code</label><input class="recv_code"></div><div class="form-col"><label class="sr-only">Name</label><input class="recv_name"></div><div style="width:120px"><label class="sr-only">Qty</label><input class="recv_qty" type="number"></div>`;
    area.appendChild(div);
  }

  function saveReceiving(){
    const date = document.getElementById("recv_date").value;
    const vendor = document.getElementById("recv_vendor").value;
    const method = document.getElementById("recv_method").value;
    const rows = Array.from(document.querySelectorAll("#recv_items_area .form-row"));
    const items = [];
    rows.forEach(r=>{
      const code = r.querySelector(".recv_code").value.trim();
      const name = r.querySelector(".recv_name").value.trim();
      const qty = Number(r.querySelector(".recv_qty").value||0);
      if(code && qty) items.push({ code, name, qty });
    });
    if(items.length===0) return alert("No items");

    // push log
    const rec = { date, vendor, method, items, createdAt:new Date().toISOString() };
    db.ref("receiving_log").push(rec).then(()=>{
      // update stock quantities
      items.forEach(it=>{
        // find existing material by code
        db.ref("materials").orderByChild("code").equalTo(it.code).once("value").then(snap=>{
          if(snap.exists()){
            const key = Object.keys(snap.val())[0];
            const data = snap.val()[key];
            const newQty = (Number(data.qty||0) + Number(it.qty));
            db.ref("materials/"+key).update({ qty: newQty, lastUpdate: new Date().toISOString() });
          } else {
            // create new material record
            db.ref("materials").push({ code: it.code, name: it.name||"", qty: it.qty, createdAt:new Date().toISOString() });
          }
        });
      });
      alert("Saved receiving and updated stock");
      renderReceiving();
    });
  }

  function loadStock(){
    db.ref("materials").once("value").then(snap=>{
      const list = snap.val() || {};
      let html = `<table><thead><tr><th>Code</th><th>Name</th><th>Qty</th><th>Unit</th><th>Last</th></tr></thead><tbody>`;
      Object.values(list).forEach(m=>{
        html += `<tr><td>${escapeHtml(m.code||"")}</td><td>${escapeHtml(m.name||"")}</td><td>${m.qty||0}</td><td>${escapeHtml(m.unit||"PCS")}</td><td>${escapeHtml(m.lastUpdate||"")}</td></tr>`;
      });
      html += `</tbody></table>`;
      const el = document.getElementById("stockList");
      if(el) el.innerHTML = html;
    });
  }

  function loadRecvLog(){
    db.ref("receiving_log").limitToLast(100).once("value").then(snap=>{
      const list = snap.val() || {};
      let html = `<table><thead><tr><th>Date</th><th>Vendor</th><th>Items</th></tr></thead><tbody>`;
      Object.values(list).forEach(r=>{
        html += `<tr><td>${escapeHtml(r.date||"")}</td><td>${escapeHtml(r.vendor||"")}</td><td>${escapeHtml((r.items||[]).map(i=>i.code+":"+i.qty).join(", "))}</td></tr>`;
      });
      html += `</tbody></table>`;
      const el = document.getElementById("recvLog");
      if(el) el.innerHTML = html;
    });
  }

  /* ---------------------------
     Orders (간단)
  --------------------------- */
  function renderOrders(){
    content.innerHTML = `
      <h1>Orders</h1>
      <div class="card">
        <div class="form-row">
          <div class="form-col"><label>Order No</label><input id="order_no"></div>
          <div class="form-col"><label>Buyer</label><input id="order_buyer"></div>
          <div style="width:160px"><label>Product Code</label><input id="order_code"></div>
          <div style="width:120px"><label>Qty</label><input id="order_qty" type="number"></div>
          <div style="width:140px"><label>Unit Price</label><input id="order_price" type="number"></div>
        </div>
        <div style="margin-top:8px">
          <label>Memo</label><textarea id="order_memo" rows="2"></textarea>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end"><button id="order_save" class="btn primary">Save</button></div>
      </div>

      <div class="card"><h3>Order List</h3><div id="order_list">Loading...</div></div>
    `;
    document.getElementById("order_save").addEventListener("click", ()=>{
      const obj = {
        orderNo: document.getElementById("order_no").value.trim(),
        buyer: document.getElementById("order_buyer").value.trim(),
        product: document.getElementById("order_code").value.trim(),
        qty: Number(document.getElementById("order_qty").value||0),
        price: Number(document.getElementById("order_price").value||0),
        memo: document.getElementById("order_memo").value.trim(),
        createdAt: new Date().toISOString()
      };
      db.ref("orders").push(obj).then(()=>{ alert("Saved"); loadOrdersList(); });
    });
    loadOrdersList();
  }

  function loadOrdersList(){
    db.ref("orders").limitToLast(200).once("value").then(snap=>{
      const list = snap.val() || {};
      let html = `<table><thead><tr><th>No</th><th>Buyer</th><th>Product</th><th>Qty</th><th>Price</th></tr></thead><tbody>`;
      Object.values(list).forEach(o=>{
        html += `<tr><td>${escapeHtml(o.orderNo||"")}</td><td>${escapeHtml(o.buyer||"")}</td><td>${escapeHtml(o.product||"")}</td><td>${o.qty||0}</td><td>${o.price||0}</td></tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("order_list").innerHTML = html;
    });
  }

  /* ---------------------------
     Excel Upload (Materials)
  --------------------------- */
  function renderExcelUpload(){
    content.innerHTML = `
      <h1>Excel Upload - Material Master</h1>
      <div class="card">
        <label>Choose .xlsx file (Sheet header should include at least: code, name, qty, category)</label>
        <input id="excelFile" type="file" accept=".xlsx,.xls">
        <div style="margin-top:8px"><button id="previewBtn" class="btn">Preview</button><button id="uploadBtn" class="btn primary">Upload to Materials</button></div>
      </div>
      <div class="card"><h3>Preview</h3><div id="excelPreview">No preview</div></div>
    `;
    document.getElementById("previewBtn").addEventListener("click", previewExcel);
    document.getElementById("uploadBtn").addEventListener("click", uploadExcel);
  }

  let lastPreviewRows = null;
  function previewExcel(){
    const file = document.getElementById("excelFile").files[0];
    if(!file) return alert("Select file");
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:"array"});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
      lastPreviewRows = rows;
      // render small table
      let html = "<table><thead><tr>";
      rows[0].forEach(h=> html += `<th>${escapeHtml(h)}</th>`);
      html += "</tr></thead><tbody>";
      rows.slice(1,21).forEach(r=>{
        html += "<tr>";
        rows[0].forEach((_,i)=> html += `<td>${escapeHtml(r[i]||"")}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      document.getElementById("excelPreview").innerHTML = html;
    };
    reader.readAsArrayBuffer(file);
  }

  function uploadExcel(){
    if(!lastPreviewRows) return alert("Preview first");
    const headers = lastPreviewRows[0].map(h=>String(h).trim());
    const rows = lastPreviewRows.slice(1);
    // check mandatory
    const codeIdx = headers.indexOf("code");
    const nameIdx = headers.indexOf("name");
    if(codeIdx < 0 || nameIdx < 0) return alert("Headers must include 'code' and 'name'");

    // push each
    rows.forEach(r=>{
      const code = r[codeIdx];
      const name = r[nameIdx];
      const qty = Number(r[headers.indexOf("qty")]||0);
      const category = r[headers.indexOf("category")] || "";
      if(!code || !name) return;
      db.ref("materials").push({ code, name, qty:qty||0, category, unit: "PCS", createdAt:new Date().toISOString() });
    });
    alert("Uploaded materials");
    lastPreviewRows = null;
    renderExcelUpload();
  }

  /* ---------------------------
     MRP placeholder
  --------------------------- */
  function renderMRP(){
    content.innerHTML = `<h1>MRP / Purchase (placeholder)</h1><div class="card"><p class="muted">MRP engine will calculate net requirements and generate purchase orders based on BOM/stock. (Work in progress)</p></div>`;
  }

  /* =================================================
     Utility
  ================================================= */
  function escapeHtml(s){ if(s==null) return ""; return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  /* =================================================
     Start: render basic UI and login modal
  ================================================= */
  // initial menu render
  renderMenu();

  // show login modal if not logged in
  loginModal.classList.remove("hidden");

  // quick hotkeys: open employees when logged in for convenience
  document.addEventListener("keydown", (e)=>{
    if(e.ctrlKey && e.key === "e") {
      // ctrl+e -> employees (if logged)
      if(!currentUser) return;
      const btn = Array.from(document.querySelectorAll(".menu-btn")).find(b=>b.dataset.key==="employees");
      if(btn) { btn.click(); }
    }
  });

  // Expose some functions to console for debugging
  window.htori = { db, renderMenu, setLanguage, showPage, renderProcessMaster };

  </script>
</body>
</html>
