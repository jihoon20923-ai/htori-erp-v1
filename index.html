<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI Realtime ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}
header{background:#020617;padding:12px;display:flex;justify-content:space-between}
aside{width:220px;background:#020617;height:100vh;padding:10px}
main{flex:1;padding:15px}
button,input,select{padding:8px;border-radius:6px;border:1px solid #333;background:#020617;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #333;padding:6px;text-align:center}
.page{display:none}
.layout{display:flex}
.form-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
</style>
</head>

<body>

<!-- ✅ LOGIN -->
<div id="loginBox">
  <h2 style="padding:20px">HTORI ERP LOGIN</h2>
  <div style="padding:20px">
    <input id="loginId" placeholder="ID"><br><br>
    <input id="loginPw" type="password" placeholder="Password"><br><br>
    <button onclick="login()">LOGIN</button>
  </div>
</div>

<!-- ✅ ERP -->
<div id="erp" style="display:none">

<header>
  <b>HTORI REALTIME ERP</b>
</header>

<div class="layout">
<aside id="menu"></aside>

<main>

<div id="page-dashboard" class="page">
  <h2>Dashboard</h2>
  <p>실시간 ERP 정상 동작 중</p>
</div>

<!-- ================= EMPLOYEE ================= -->
<div id="page-employee" class="page">
<h2>직원 등록</h2>
<div class="form-row">
  <input id="eId" placeholder="ID">
  <input id="ePw" placeholder="PW">
  <input id="eName" placeholder="Name">
  <select id="eRole">
    <option value="master">Master</option>
    <option value="sales">Sales</option>
    <option value="production">Production</option>
  </select>
  <button onclick="addEmployee()">등록</button>
</div>

<table>
<thead><tr><th>ID</th><th>Name</th><th>Role</th></tr></thead>
<tbody id="empBody"></tbody>
</table>
</div>

<!-- ================= STOCK (입고 + 이력) ================= -->
<div id="page-stock" class="page">
<h2>재고 입고</h2>

<div class="form-row">
  <input id="inDate" type="date">
  <input id="inVendor" placeholder="Vendor">
  <select id="inMethod">
    <option value="SEA">SEA</option>
    <option value="AIR">AIR</option>
  </select>
  <input id="sCode" placeholder="Code">
  <input id="sQty" type="number" placeholder="Qty">
  <button onclick="addStock()">입고 등록</button>
</div>

<h3>현재 재고</h3>
<table>
<thead><tr><th>Code</th><th>Qty</th></tr></thead>
<tbody id="stockBody"></tbody>
</table>

<hr>
<h3>입고 이력</h3>
<table>
<thead><tr><th>Date</th><th>Vendor</th><th>Method</th><th>Code</th><th>Qty</th></tr></thead>
<tbody id="stockInLogBody"></tbody>
</table>

<hr>
<h3>재고 엑셀 업로드</h3>
<select id="uploadMode">
  <option value="append">기존 재고에 추가</option>
  <option value="overwrite">기존 재고 덮어쓰기</option>
</select>
<input type="file" id="excelFile" accept=".csv">
<button onclick="uploadStockExcel()">업로드</button>
<button onclick="downloadStockExcel()">다운로드</button>
</div>

<!-- ================= ORDER (조회 전용) ================= -->
<div id="page-order" class="page">
<h2>주문 (조회 전용)</h2>

<div class="form-row">
  <input id="oNo" placeholder="Order No">
  <input id="oProduct" placeholder="Product">
  <input id="oQty" type="number" placeholder="Qty">
  <input id="oPrice" type="number" step="0.001" placeholder="Unit Price">
  <input id="oDue" type="date">
  <button onclick="addOrder()">주문 등록</button>
</div>

<h3>주문 목록 (Order No 클릭)</h3>
<table>
<thead><tr><th>Order No</th><th>Due</th></tr></thead>
<tbody id="orderListBody"></tbody>
</table>

<hr>
<h3>선택 주문 상세</h3>
<table>
<thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
<tbody id="orderDetailBody"></tbody>
</table>
<p id="orderTotalSum"></p>

<hr>
<h3>주문 엑셀</h3>
<input type="file" id="orderExcelFile" accept=".csv">
<button onclick="uploadOrderExcel()">업로드</button>
<button onclick="downloadOrderExcel()">다운로드</button>
</div>

<!-- ================= SHIPMENT ================= -->
<div id="page-shipment" class="page">
<h2>수출 (Shipment)</h2>

<div class="form-row">
  <input id="shipNo" placeholder="Shipment No">
  <input id="shipBuyer" placeholder="Buyer">
  <input id="shipDate" type="date">
</div>

<div class="form-row">
  <input id="shipProduct" placeholder="Product">
  <input id="shipQty" type="number" placeholder="Qty">
  <input id="shipPrice" type="number" step="0.001" placeholder="Price">
  <button onclick="addShipItem()">품목 추가</button>
</div>

<table>
<thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th>Del</th></tr></thead>
<tbody id="shipItemBody"></tbody>
</table>

<p id="shipSum"></p>
<button onclick="saveShipment()">수출 저장</button>

<hr>
<h3>수출 목록</h3>
<table>
<thead><tr><th>Shipment No</th><th>Buyer</th><th>Date</th><th>Total</th></tr></thead>
<tbody id="shipListBody"></tbody>
</table>
</div>

</main>
</div>
</div>

<script>
// ================= FIREBASE =================
var firebaseConfig = {
  apiKey: "AIzaSyDwiTlPtoXraEtA7TzTctdH6DJS6gdSEGQ",
  authDomain: "htori-erp-3c22b.firebaseapp.com",
  databaseURL: "https://htori-erp-3c22b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "htori-erp-3c22b",
  storageBucket: "htori-erp-3c22b.firebasestorage.app",
  messagingSenderId: "975336397666",
  appId: "1:975336397666:web:ae45a471e51bf71e9dea3b"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// ✅ 최초 admin 생성 (1회)
db.ref("employees").once("value").then(snap=>{
  const list = snap.val() || [];
  if(list.length === 0){
    list.push({id:"admin",pw:"1234",name:"Master",role:"master"});
    db.ref("employees").set(list);
  }
});

// ================= LOGIN =================
let currentUser=null;
function login(){
  const id = loginId.value.trim();
  const pw = loginPw.value.trim();

  db.ref("employees").once("value").then(snap=>{
    const list = snap.val() || [];
    const found = list.find(e => e.id === id && e.pw === pw);

    if(!found){
      alert("로그인 실패");
      return;
    }

    currentUser = found;
    loginBox.style.display="none";
    erp.style.display="block";
    buildMenu();
    showPage("dashboard");
  });
}

// ================= MENU =================
function buildMenu(){
menu.innerHTML="";
const map={
  master:["dashboard","employee","stock","order","shipment"],
  sales:["dashboard","order","shipment"],
  production:["dashboard","stock"]
};
map[currentUser.role].forEach(p=>{
  const b=document.createElement("button");
  b.innerText=p.toUpperCase();
  b.onclick=()=>showPage(p);
  menu.appendChild(b);
});
}

function showPage(p){
document.querySelectorAll(".page").forEach(x=>x.style.display="none");
document.getElementById("page-"+p).style.display="block";
}

// ================= EMPLOYEE =================
function addEmployee(){
db.ref("employees").once("value").then(snap=>{
  const list = snap.val() || [];
  if(list.find(x=>x.id===eId.value)){alert("중복 ID");return;}
  list.push({id:eId.value,pw:ePw.value,name:eName.value,role:eRole.value});
  db.ref("employees").set(list);
});
}

db.ref("employees").on("value", snap=>{
  const list = snap.val() || [];
  empBody.innerHTML="";
  list.forEach(e=>{
    empBody.innerHTML+=`<tr><td>${e.id}</td><td>${e.name}</td><td>${e.role}</td></tr>`;
  });
});

// ================= STOCK =================
function addStock(){
  const date=inDate.value, vendor=inVendor.value, method=inMethod.value;
  const code=sCode.value.trim(), qty=Number(sQty.value);

  if(!date||!vendor||!method||!code||!qty){alert("입고 정보 누락");return;}

  db.ref("stock").once("value").then(snap=>{
    const stock=snap.val()||[];
    const found=stock.find(x=>x.code===code);
    if(found) found.qty+=qty;
    else stock.push({code,qty});
    db.ref("stock").set(stock);
  });

  db.ref("stock_in_log").once("value").then(snap=>{
    const log=snap.val()||[];
    log.push({date,vendor,method,code,qty});
    db.ref("stock_in_log").set(log);
  });

  alert("입고 완료");
}

db.ref("stock").on("value", snap=>{
  const list=snap.val()||[];
  stockBody.innerHTML="";
  list.forEach(s=>{
    stockBody.innerHTML+=`<tr><td>${s.code}</td><td>${s.qty}</td></tr>`;
  });
});

db.ref("stock_in_log").on("value", snap=>{
  const list=snap.val()||[];
  stockInLogBody.innerHTML="";
  list.forEach(l=>{
    stockInLogBody.innerHTML+=`<tr>
      <td>${l.date}</td><td>${l.vendor}</td><td>${l.method}</td>
      <td>${l.code}</td><td>${l.qty}</td></tr>`;
  });
});

// ================= STOCK EXCEL =================
function uploadStockExcel(){
  const file = excelFile.files[0];
  const mode = uploadMode.value;
  if(!file){alert("파일 선택");return;}

  const reader=new FileReader();
  reader.onload=function(e){
    const rows=e.target.result.split("\n");

    db.ref("stock").once("value").then(snap=>{
      let list = mode==="append" ? (snap.val()||[]) : [];

      rows.slice(1).forEach(r=>{
        const c=r.split(",");
        const code=c[0]?.trim();
        const qty=Number(c[1]);
        if(!code||!qty)return;

        const found=list.find(x=>x.code===code);
        if(found) found.qty+=qty;
        else list.push({code,qty});
      });

      db.ref("stock").set(list);
      alert("업로드 완료");
    });
  };
  reader.readAsText(file);
}

function downloadStockExcel(){
  db.ref("stock").once("value").then(snap=>{
    const list=snap.val()||[];
    let csv="Code,Qty\n";
    list.forEach(s=>csv+=`${s.code},${s.qty}\n`);
    downloadCSV(csv,"stock.csv");
  });
}

// ================= ORDER =================
function addOrder(){
  const orderNo=oNo.value, product=oProduct.value;
  const qty=Number(oQty.value), price=Number(oPrice.value), due=oDue.value;

  db.ref("orders").once("value").then(snap=>{
    const list=snap.val()||[];
    list.push({orderNo,product,qty,price,due});
    db.ref("orders").set(list);
  });
}

let selectedOrderNo=null;
db.ref("orders").on("value", snap=>{
  const list=snap.val()||[];
  const grouped={};

  list.forEach(o=>{
    if(!grouped[o.orderNo]) grouped[o.orderNo]={due:o.due, items:[]};
    grouped[o.orderNo].items.push(o);
  });

  orderListBody.innerHTML="";
  Object.keys(grouped).forEach(no=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td style="cursor:pointer;color:#60a5fa">${no}</td><td>${grouped[no].due}</td>`;
    tr.onclick=()=>showOrderDetail(no, grouped[no]);
    orderListBody.appendChild(tr);
  });

  if(selectedOrderNo && grouped[selectedOrderNo]){
    showOrderDetail(selectedOrderNo, grouped[selectedOrderNo]);
  }
});

function showOrderDetail(no,data){
  selectedOrderNo=no;
  orderDetailBody.innerHTML="";
  let sum=0;

  data.items.forEach(o=>{
    const total=o.qty*o.price;
    sum+=total;
    orderDetailBody.innerHTML+=`<tr>
      <td>${o.product}</td><td>${o.qty}</td>
      <td>${o.price}</td><td>${total.toFixed(2)}</td></tr>`;
  });

  orderTotalSum.innerText="총 금액: "+sum.toFixed(2);
}

// ================= ORDER EXCEL =================
function uploadOrderExcel(){
  const file=orderExcelFile.files[0];
  if(!file){alert("파일 선택");return;}

  const reader=new FileReader();
  reader.onload=function(e){
    const rows=e.target.result.split("\n");

    db.ref("orders").once("value").then(snap=>{
      const list=snap.val()||[];

      rows.slice(1).forEach(r=>{
        const c=r.split(",");
        const no=c[0]?.trim(), product=c[1]?.trim(), qty=Number(c[2]);
        if(no&&product&&qty) list.push({orderNo:no,product,qty});
      });

      db.ref("orders").set(list);
      alert("주문 업로드 완료");
    });
  };
  reader.readAsText(file);
}

function downloadOrderExcel(){
  db.ref("orders").once("value").then(snap=>{
    const list=snap.val()||[];
    let csv="OrderNo,Product,Qty\n";
    list.forEach(o=>csv+=`${o.orderNo},${o.product},${o.qty}\n`);
    downloadCSV(csv,"orders.csv");
  });
}

// ================= SHIPMENT =================
let currentShipItems=[];

function addShipItem(){
  const product=shipProduct.value, qty=Number(shipQty.value), price=Number(shipPrice.value);
  if(!product||!qty||!price){alert("누락");return;}

  currentShipItems.push({product,qty,price});
  renderShipItems();
}

function renderShipItems(){
  shipItemBody.innerHTML="";
  let sum=0;

  currentShipItems.forEach((i,idx)=>{
    const total=i.qty*i.price;
    sum+=total;
    shipItemBody.innerHTML+=`<tr>
      <td>${i.product}</td><td>${i.qty}</td><td>${i.price}</td>
      <td>${total.toFixed(2)}</td>
      <td><button onclick="removeShipItem(${idx})">X</button></td></tr>`;
  });

  shipSum.innerText="Shipment Total: "+sum.toFixed(2);
}

function removeShipItem(i){
  currentShipItems.splice(i,1);
  renderShipItems();
}

function saveShipment(){
  const shipNoV=shipNo.value, buyer=shipBuyer.value, shipDateV=shipDate.value;
  if(!shipNoV||!buyer||!shipDateV||currentShipItems.length===0){
    alert("수출 정보 누락");return;
  }

  db.ref("shipments").once("value").then(snap=>{
    const list=snap.val()||[];
    list.push({shipNo:shipNoV,buyer,shipDate:shipDateV,items:currentShipItems});
    db.ref("shipments").set(list);

    alert("수출 저장 완료");
    currentShipItems=[];
    shipItemBody.innerHTML="";
    shipSum.innerText="";
  });
}

db.ref("shipments").on("value", snap=>{
  const list=snap.val()||[];
  shipListBody.innerHTML="";

  list.forEach(s=>{
    let total=0;
    s.items.forEach(i=>total+=i.qty*i.price);
    shipListBody.innerHTML+=`<tr>
      <td>${s.shipNo}</td><td>${s.buyer}</td><td>${s.shipDate}</td>
      <td>${total.toFixed(2)}</td></tr>`;
  });
});

// ================= CSV DOWNLOAD =================
function downloadCSV(content, filename){
  const blob=new Blob([content],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
