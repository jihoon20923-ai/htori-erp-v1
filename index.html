<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Factory ERP Final</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    h2, h3 { margin-top: 20px; }
    .form-row { margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    input, select, button { padding: 6px; }
    button { cursor: pointer; }
    table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    .page { display: none; }
  </style>
</head>
<body>

<h1>Factory ERP Final</h1>

<div class="form-row">
  <button onclick="showPage('employee')">Employee</button>
  <button onclick="showPage('bom')">BOM</button>
  <button onclick="showPage('production')">Production</button>
  <button onclick="showPage('stock')">Stock</button>
  <button onclick="showPage('payroll')">Payroll</button>
  <button onclick="showPage('export')">Export / CBM</button>
</div>

<hr>

<!-- EMPLOYEE -->
<div id="page-employee" class="page">
  <h2>Employee</h2>
  <div class="form-row">
    <input id="empId" placeholder="ID">
    <input id="empName" placeholder="Name">
    <select id="empPayType">
      <option value="piece">Piece</option>
      <option value="monthly">Monthly</option>
    </select>
    <input id="empUnitPay" type="number" placeholder="Unit Pay">
    <button onclick="addEmployee()">Add</button>
  </div>
  <table>
    <thead><tr><th>ID</th><th>Name</th><th>PayType</th><th>UnitPay</th><th>Del</th></tr></thead>
    <tbody id="empBody"></tbody>
  </table>
</div>

<!-- BOM -->
<div id="page-bom" class="page">
  <h2>BOM</h2>
  <div class="form-row">
    <input id="bomProduct" placeholder="Product">
    <input id="bomProcess" placeholder="Process">
    <input id="bomInputCode" placeholder="Input Code">
    <input id="bomInputQty" type="number" placeholder="Qty">
    <input id="bomUnitCost" type="number" placeholder="Unit Cost">
    <input id="bomOutputCode" placeholder="Output Code">
    <button onclick="saveBOM()">Save</button>
  </div>
  <table>
    <thead>
      <tr><th>Product</th><th>Process</th><th>Input</th><th>Qty</th><th>Cost</th><th>Output</th><th>Edit</th></tr>
    </thead>
    <tbody id="bomBody"></tbody>
  </table>
</div>

<!-- PRODUCTION -->
<div id="page-production" class="page">
  <h2>Production</h2>
  <div class="form-row">
    <input id="prodDate" type="date">
    <input id="prodProduct" placeholder="Product">
    <input id="prodProcess" placeholder="Process">

    <input id="prodInputCode" placeholder="Input Code" oninput="autoFillName('prodInputCode','prodInputName')">
    <input id="prodInputName" placeholder="Input Name">

    <input id="prodInputQty" type="number" placeholder="Input Qty">

    <input id="prodOutputCode" placeholder="Output Code" oninput="autoFillName('prodOutputCode','prodOutputName')">
    <input id="prodOutputName" placeholder="Output Name">

    <input id="prodGoodQty" type="number" placeholder="Good Qty">
    <input id="prodDefectQty" type="number" placeholder="Defect Qty">
    <input id="prodWorker" placeholder="Worker ID">
    <input id="prodNote" placeholder="Note">

    <button onclick="saveProduction()">Save</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Product</th><th>Process</th>
        <th>Input</th><th>Output</th><th>Good</th>
        <th>Defect</th><th>Worker</th><th>Note</th><th>Edit</th>
      </tr>
    </thead>
    <tbody id="prodBody"></tbody>
  </table>
</div>

<!-- STOCK -->
<div id="page-stock" class="page">
  <h2>Stock</h2>
  <table>
    <thead><tr><th>Code</th><th>Name</th><th>Good</th><th>Defect</th></tr></thead>
    <tbody id="stockBody"></tbody>
  </table>
</div>

<!-- PAYROLL -->
<div id="page-payroll" class="page">
  <h2>Payroll</h2>
  <div class="form-row">
    <input id="payrollMonth" type="month">
    <button onclick="calcPayroll()">Calculate</button>
    <button onclick="downloadPayroll()">Download CSV</button>
  </div>
  <table>
    <thead><tr><th>ID</th><th>Name</th><th>Qty</th><th>Salary</th></tr></thead>
    <tbody id="payrollBody"></tbody>
  </table>
</div>

<!-- EXPORT / CBM -->
<div id="page-export" class="page">
  <h2>Export / CBM</h2>

  <h3>Packing Standard</h3>
  <div class="form-row">
    <input id="packCode" placeholder="Product Code">
    <input id="innerQty" type="number" placeholder="Inner / Unit">
    <input id="cartonQty" type="number" placeholder="Carton / Unit">
    <button onclick="savePackingStandard()">Save Standard</button>
  </div>

  <table>
    <thead><tr><th>Code</th><th>Inner</th><th>Carton</th><th>Edit</th></tr></thead>
    <tbody id="packingBody"></tbody>
  </table>

  <hr>

  <h3>CBM Calculator</h3>
  <div class="form-row">
    <input id="cbmCode" placeholder="Product Code">
    <input id="unitQty" type="number" placeholder="Finished Qty">
  </div>
  <div class="form-row">
    <input id="boxL" type="number" placeholder="Length (cm)">
    <input id="boxW" type="number" placeholder="Width (cm)">
    <input id="boxH" type="number" placeholder="Height (cm)">
    <button onclick="calcCBMByStandard()">Calculate</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Product</th><th>Finished</th><th>Inner</th><th>Carton</th>
        <th>CBM</th><th>Total CBM</th><th>20FT</th><th>40HQ</th>
        <th>Edit</th><th>Del</th>
      </tr>
    </thead>
    <tbody id="cbmBody"></tbody>
  </table>
</div>

<script>
function load(key){ return JSON.parse(localStorage.getItem(key)||"[]"); }
function save(key,val){ localStorage.setItem(key,JSON.stringify(val)); }

let editingCBMIndex = null;

function showPage(page){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById("page-"+page).style.display="block";
}

function autoFillName(codeId, nameId){
  const code=document.getElementById(codeId).value.trim();
  const nameInput=document.getElementById(nameId);
  const stock=load("stock");
  const found=stock.find(s=>s.code===code);
  if(found && found.name){ nameInput.value=found.name; nameInput.readOnly=true; }
  else { nameInput.value=""; nameInput.readOnly=false; }
}

/* EMPLOYEE / BOM / PRODUCTION / STOCK / PAYROLL */
/* ---- 기존 로직 유지 ---- */

function savePackingStandard(){
  const code=packCode.value.trim();
  const inner=Number(innerQty.value);
  const carton=Number(cartonQty.value);
  if(!code||!inner||!carton)return;

  const list=load("packingStandard");
  const exist=list.find(p=>p.code===code);
  if(exist){ exist.inner=inner; exist.carton=carton; }
  else list.push({code,inner,carton});
  save("packingStandard",list);
  renderPackingStandard();
}

function renderPackingStandard(){
  packingBody.innerHTML="";
  load("packingStandard").forEach((p,i)=>{
    packingBody.innerHTML+=`<tr><td>${p.code}</td><td>${p.inner}</td><td>${p.carton}</td>
    <td><button onclick="editPackingStandard(${i})">Edit</button></td></tr>`;
  });
}

function editPackingStandard(i){
  const p=load("packingStandard")[i];
  packCode.value=p.code; innerQty.value=p.inner; cartonQty.value=p.carton;
}

function calcCBMByStandard(){
  const code=cbmCode.value.trim();
  const unitQtyVal=Number(unitQty.value);
  const L=Number(boxL.value),W=Number(boxW.value),H=Number(boxH.value);
  if(!code||!unitQtyVal||!L||!W||!H)return;

  const std=load("packingStandard").find(p=>p.code===code);
  if(!std)return alert("No Packing Standard");

  const innerBoxQty=Math.ceil(unitQtyVal/std.inner);
  const cartonBoxQty=Math.ceil(unitQtyVal/std.carton);
  const cbmPerCarton=(L*W*H)/1000000;
  const totalCBM=cbmPerCarton*cartonBoxQty;

  const FT20=33,FT40HQ=68;
  const fit20=Math.floor(FT20/cbmPerCarton);
  const fit40=Math.floor(FT40HQ/cbmPerCarton);

  const list=load("cbmLog");
  const newItem={code,unitQtyVal,innerBoxQty,cartonBoxQty,cbmPerCarton,totalCBM,fit20,fit40,L,W,H};

  if(editingCBMIndex!==null){
    list[editingCBMIndex]=newItem;
    editingCBMIndex=null;
  }else{
    list.push(newItem);
  }

  save("cbmLog",list);
  renderCBMLog();
}

function renderCBMLog(){
  cbmBody.innerHTML="";
  load("cbmLog").forEach((c,i)=>{
    cbmBody.innerHTML+=`
      <tr>
        <td>${c.code}</td><td>${c.unitQtyVal}</td><td>${c.innerBoxQty}</td>
        <td>${c.cartonBoxQty}</td><td>${c.cbmPerCarton.toFixed(4)}</td>
        <td>${c.totalCBM.toFixed(2)}</td><td>${c.fit20}</td><td>${c.fit40}</td>
        <td><button onclick="editCBM(${i})">Edit</button></td>
        <td><button onclick="deleteCBM(${i})">Del</button></td>
      </tr>`;
  });
}

function editCBM(i){
  const c=load("cbmLog")[i];
  cbmCode.value=c.code;
  unitQty.value=c.unitQtyVal;
  boxL.value=c.L;
  boxW.value=c.W;
  boxH.value=c.H;
  editingCBMIndex=i;
}

function deleteCBM(i){
  if(!confirm("Delete?"))return;
  const l=load("cbmLog");
  l.splice(i,1);
  save("cbmLog",l);
  renderCBMLog();
}

showPage("employee");
renderPackingStandard();
renderCBMLog();
</script>

</body>
</html>
