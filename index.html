<script>
/* =================================================
   Firebase CONFIG
================================================= */
const firebaseConfig = {
  apiKey: "AIzaSyDwiTlPtoXraEtA7TzTctdH6DJS6gdSEGQ",
  authDomain: "htori-erp-3c22b.firebaseapp.com",
  databaseURL: "https://htori-erp-3c22b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "htori-erp-3c22b",
  storageBucket: "htori-erp-3c22b.firebasestorage.app",
  messagingSenderId: "975336397666",
  appId: "1:975336397666:web:ae45a471e51bf71e9dea3b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =================================================
   AUTO CREATE ADMIN
================================================= */
(async function ensureAdmin(){
  const snap = await db.ref("employees").once("value");
  const list = snap.val() || {};
  const hasAdmin = Object.values(list).some(e => e?.id === "admin");

  if (!hasAdmin) {
    await db.ref("employees").push({
      id: "admin",
      pw: "1234",
      name: "Master",
      role: "master",
      createdAt: new Date().toISOString()
    });
    console.log("✅ admin created");
  } else {
    console.log("ℹ admin exists");
  }
})();

/* =================================================
   STATE
================================================= */
let currentUser = null;
let lang = localStorage.getItem("htori_lang") || "EN";

const DEFAULT_MENU = [
  "dashboard","production","employees","settings"
];

const T = {
  EN:{ dashboard:"Dashboard", production:"Production", employees:"Employees", settings:"Settings" },
  KR:{ dashboard:"대시보드", production:"생산", employees:"직원관리", settings:"설정" },
  ID:{ dashboard:"Dasbor", production:"Produksi", employees:"Karyawan", settings:"Pengaturan" }
};

/* =================================================
   DOM READY (⭐ 핵심 수정 부분)
================================================= */
document.addEventListener("DOMContentLoaded", () => {

  // DOM refs
  const menuList   = document.getElementById("menuList");
  const content    = document.getElementById("content");
  const loginModal = document.getElementById("loginModal");

  const loginBtn  = document.getElementById("loginBtn");
  const demoBtn   = document.getElementById("demoBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const userNameSpan = document.getElementById("user-name");
  const userRoleSpan = document.getElementById("user-role");

  /* -------------------------
     MENU
  ------------------------- */
  function renderMenu(){
    menuList.innerHTML = "";
    DEFAULT_MENU.forEach(key=>{
      const btn = document.createElement("button");
      btn.className = "menu-btn";
      btn.textContent = T[lang][key] || key;
      btn.onclick = () => showPage(key);
      menuList.appendChild(btn);
    });
  }

  /* -------------------------
     PAGES
  ------------------------- */
  function showPage(key){
    if(key === "dashboard"){
      content.innerHTML = "<h1>Dashboard</h1>";
    }
    if(key === "production"){
      content.innerHTML = "<h1>Production</h1>";
    }
    if(key === "employees"){
      content.innerHTML = "<h1>Employees</h1>";
    }
    if(key === "settings"){
      content.innerHTML = "<h1>Settings</h1>";
    }
  }

  /* -------------------------
     LOGIN
  ------------------------- */
  loginBtn.onclick = () => {
    const id = document.getElementById("loginId").value.trim();
    const pw = document.getElementById("loginPw").value.trim();

    db.ref("employees").once("value").then(snap=>{
      const list = snap.val() || {};
      const user = Object.values(list).find(u => u.id === id && u.pw === pw);

      if(!user){
        alert("LOGIN FAIL");
        return;
      }

      currentUser = user;
      userNameSpan.textContent = user.name || user.id;
      userRoleSpan.textContent = user.role || "user";

      loginModal.classList.add("hidden");
      logoutBtn.classList.remove("hidden");

      renderMenu();
      showPage("dashboard");
    });
  };

  demoBtn.onclick = () => {
    currentUser = { id:"guest", name:"Guest", role:"viewer" };
    userNameSpan.textContent = "Guest";
    userRoleSpan.textContent = "viewer";
    loginModal.classList.add("hidden");
    renderMenu();
    showPage("dashboard");
  };

  logoutBtn.onclick = () => {
    currentUser = null;
    userNameSpan.textContent = "Guest";
    userRoleSpan.textContent = "viewer";
    logoutBtn.classList.add("hidden");
    loginModal.classList.remove("hidden");
  };

  /* -------------------------
     INIT
  ------------------------- */
  renderMenu();
  loginModal.classList.remove("hidden");
});
</script>
